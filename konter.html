<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Toko Siap Antar</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f5f5f5;padding-bottom:120px}
h2{padding:15px;margin:0;background:#0a8f3c;color:white}

input{padding:10px;width:100%;box-sizing:border-box;border-radius:6px;border:1px solid #ddd;margin-bottom:10px}

.card{
 background:#fff;
 margin:10px;
 padding:12px;
 border-radius:10px;
 box-shadow:0 2px 6px rgba(0,0,0,0.1)
}

.harga{color:#0a8f3c;font-weight:bold}

.qty-box{
 display:flex;
 align-items:center;
 gap:10px;
}

.qty-btn{
 width:30px;
 height:30px;
 border:none;
 background:#0a8f3c;
 color:white;
 border-radius:6px;
 font-weight:bold;
}

#map{height:220px;margin:10px;border-radius:10px}

.cart{
 position:fixed;
 bottom:0;
 left:0;
 right:0;
 background:white;
 box-shadow:0 -2px 10px rgba(0,0,0,0.2);
 padding:12px;
}

.cart button{
 width:100%;
 padding:12px;
 background:#0a8f3c;
 color:white;
 border:none;
 border-radius:8px;
 font-weight:bold;
}
</style>
</head>
<body>

<h2>üõí TOKO SIAP ANTAR</h2>

<div style="padding:10px">
<input id="cari" placeholder="Cari produk..." onkeyup="filterProduk()">
</div>

<div id="hasil"></div>

<h3 style="padding:10px;margin:0">üìç Pilih Lokasi Rumah</h3>
<div id="map"></div>

<div style="padding:10px">
<input id="waPembeli" placeholder="Nomor WhatsApp Anda (08xxxx)">
</div>

<div class="cart">
<div>
<b id="cartInfo">0 Produk | 0 Pcs | Rp0</b>
</div>
<button onclick="proses()">Checkout & Kirim WhatsApp</button>
</div>

<script>

// ================= GOOGLE SHEET =================
const sheetId="1iPbtRGldW5yz6tuUZ5oHzMGsnNb4cHyCbAEMkq51qK4";
const tabProduk="Stock Konter";

let dataProduk=[];
let produkDipilih={};

fetch(`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${encodeURIComponent(tabProduk)}`)
.then(r=>r.text())
.then(t=>{
 const json=JSON.parse(t.substring(47).slice(0,-2));
 const rows=json.table.rows;

 dataProduk=rows
 .filter(r=>r.c[0] && r.c[1])
 .map(r=>({
   kode:r.c[0]?.v||"",
   nama:r.c[1]?.v||"",
   harga:parseInt(r.c[3]?.v)||0,
   stok:parseInt(r.c[6]?.v)||0
 }));

 tampilProduk(dataProduk);
});

// ================= TAMPIL PRODUK =================
function tampilProduk(list){
 hasil.innerHTML="";
 list.forEach(p=>{

 let selected=produkDipilih[p.kode];
 let qty=selected?selected.qty:0;

 hasil.innerHTML+=`
 <div class="card">
  <b>${p.nama}</b><br>
  <small>${p.kode}</small><br>
  <span class="harga">Rp ${p.harga.toLocaleString()}</span><br><br>

  ${
   qty===0
   ? `<button onclick="tambahProduk('${p.kode}')">+ Tambah</button>`
   : `
   <div class="qty-box">
    <button class="qty-btn" onclick="kurangProduk('${p.kode}')">-</button>
    <b>${qty}</b>
    <button class="qty-btn" onclick="tambahProduk('${p.kode}')">+</button>
   </div>
   `
  }
 </div>`;
 });
}

function tambahProduk(kode){
 let produk=dataProduk.find(p=>p.kode===kode);
 if(!produkDipilih[kode]){
  produkDipilih[kode]={...produk,qty:1};
 }else{
  produkDipilih[kode].qty++;
 }
 tampilProduk(dataProduk);
 updateCart();
}

function kurangProduk(kode){
 if(produkDipilih[kode]){
  produkDipilih[kode].qty--;
  if(produkDipilih[kode].qty<=0){
   delete produkDipilih[kode];
  }
 }
 tampilProduk(dataProduk);
 updateCart();
}

function filterProduk(){
 let q=cari.value.toLowerCase();
 tampilProduk(dataProduk.filter(x=>
 x.nama.toLowerCase().includes(q)||
 x.kode.toLowerCase().includes(q)
 ));
}

// ================= MAP =================
const tokoLat=-6.883831;
const tokoLng=108.302788;

let tujuanLat=null, tujuanLng=null;
let ongkirFix=0;

var map=L.map('map').setView([tokoLat,tokoLng],15);

L.tileLayer(
 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
).addTo(map);

L.marker([tokoLat,tokoLng]).addTo(map)
.bindPopup("Lokasi Toko").openPopup();

let marker;

map.on('click',function(e){
 tujuanLat=e.latlng.lat;
 tujuanLng=e.latlng.lng;
 if(marker) map.removeLayer(marker);
 marker=L.marker([tujuanLat,tujuanLng]).addTo(map)
 .bindPopup("Lokasi Rumah").openPopup();
 hitungOngkir();
});

// ================= ONGKIR =================
const kmPerLiter=50;
const hargaPerLiter=15000;
const biayaJasa=3000;
const biayaPerawatan=2000;
const minimumOngkir=10000;

async function hitungOngkir(){
 if(!tujuanLat) return;

 let r=await fetch(
 `https://router.project-osrm.org/route/v1/driving/${tokoLng},${tokoLat};${tujuanLng},${tujuanLat}?overview=false`
 );
 let data=await r.json();
 let jarakKm=data.routes[0].distance/1000;

 let bensin=jarakKm/kmPerLiter;
 let biayaBBM=(bensin*hargaPerLiter)*2;

 let ongkir=biayaBBM+biayaJasa+biayaPerawatan;
 if(ongkir<minimumOngkir) ongkir=minimumOngkir;

 ongkirFix=Math.ceil(ongkir/1000)*1000;
 updateCart();
}

// ================= CART =================
function updateCart(){

 let total=0;
 let totalItem=0;
 let jumlahProduk=Object.keys(produkDipilih).length;

 Object.values(produkDipilih).forEach(p=>{
  total += p.harga*p.qty;
  totalItem += p.qty;
 });

 let totalBayar=total+ongkirFix;

 document.getElementById("cartInfo").innerText=
 jumlahProduk+" Produk | "+totalItem+" Pcs | Rp"+totalBayar.toLocaleString();
}

// ================= PROSES WA =================
function proses(){

 let noWa=document.getElementById("waPembeli").value.trim();
 if(noWa==""){alert("Masukkan nomor WA dulu");return;}
 if(Object.keys(produkDipilih).length==0 || !tujuanLat){
  alert("Pilih produk & lokasi dulu!");
  return;
 }

 let total=0;
 let totalItem=0;
 let detail="";
 let no=1;

 Object.values(produkDipilih).forEach(p=>{
  let subtotal=p.harga*p.qty;
  total+=subtotal;
  totalItem+=p.qty;
  detail+=no+". "+p.nama+" x"+p.qty+
  " - Rp "+subtotal.toLocaleString()+"%0A";
  no++;
 });

 let totalBayar=total+ongkirFix;
 let linkMaps=`https://www.google.com/maps?q=${tujuanLat},${tujuanLng}`;

 let pesan=
 "============================%0A"+
 "üì¶ PESANAN BARU%0A"+
 "============================%0A%0A"+
 "üë§ Nomor Pembeli:%0A"+noWa+
 "%0A%0Aüõí DETAIL PRODUK%0A----------------------------%0A"+
 detail+
 "%0Aüìä RINGKASAN%0A----------------------------%0A"+
 "Jumlah Produk : "+Object.keys(produkDipilih).length+" Jenis"+
 "%0ATotal Item : "+totalItem+" Pcs"+
 "%0ATotal Barang : Rp"+total.toLocaleString()+
 "%0AOngkir : Rp"+ongkirFix.toLocaleString()+
 "%0A----------------------------%0A"+
 "TOTAL BAYAR : Rp"+totalBayar.toLocaleString()+
 "%0A%0Aüìç Lokasi:%0A"+linkMaps+
 "%0A============================";

 window.open("https://wa.me/6282319264646?text="+pesan);
}

</script>
</body>
</html>