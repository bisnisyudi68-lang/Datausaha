<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TOKO SIAP ANTAR</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body{
 font-family:Arial;
 margin:0;
 background:#f2f2f2;
 padding-bottom:130px;
}
header{
 background:#15803d;
 color:white;
 padding:15px;
 text-align:center;
 font-weight:bold;
 font-size:20px;
}
input{
 width:95%;
 padding:10px;
 margin:10px;
 border-radius:8px;
 border:1px solid #ccc;
}
.card{
 background:white;
 margin:10px;
 padding:12px;
 border-radius:12px;
 box-shadow:0 2px 6px rgba(0,0,0,0.1);
}
.harga{
 color:#15803d;
 font-weight:bold;
}
.qtyBox{
 display:flex;
 align-items:center;
 gap:10px;
}
.qtyBtn{
 background:#15803d;
 color:white;
 width:30px;
 height:30px;
 border:none;
 border-radius:6px;
}
#map{
 height:250px;
 margin:10px;
 border-radius:12px;
}
#infoArea{
 margin:10px;
 font-weight:bold;
}
.checkout{
 position:fixed;
 bottom:0;
 width:100%;
 background:#15803d;
 color:white;
 padding:15px;
 text-align:center;
 font-weight:bold;
 cursor:pointer;
}
.checkout.disabled{
 background:#9ca3af;
}
 .scroll-buttons{
  position:fixed;
  top:50%;
  right:20px;
  transform:translateY(-50%);
  display:flex;
  flex-direction:column;
  gap:14px;
  z-index:9999;
}

.scroll-buttons button{
  width:50px;
  height:50px;
  border:none;
  border-radius:50%;
  background:linear-gradient(145deg,#0d6efd,#2563eb);
  color:white;
  font-size:22px;
  box-shadow:0 8px 20px rgba(0,0,0,0.25);
  cursor:pointer;
}
</style>
</head>
<body>

<header>üõí TOKO SIAP ANTAR</header>

<input type="text" id="cari" placeholder="Cari produk..." onkeyup="renderProduk()">

<div id="listProduk"></div>

<h3 style="margin-left:10px;">üìç Pilih Lokasi Rumah</h3>
<div id="map"></div>

<button onclick="gunakanLokasi()" style="width:95%;margin:10px;background:#2563eb;color:white;">
üì° Gunakan Lokasi Saya
</button>

<div id="infoArea"></div>

<input type="text" id="waPembeli" placeholder="Nomor WhatsApp (08xxxx)">

<div class="checkout disabled" id="btnCheckout" onclick="proses()">
<span id="ringkasan">0 Produk | 0 Pcs | Rp0</span><br>
Checkout & Kirim WhatsApp
</div>

<script>

// ================= GOOGLE SHEET =================
const sheetId="1iPbtRGldW5yz6tuUZ5oHzMGsnNb4cHyCbAEMkq51qK4";
const sheetName="Stock Konter";

let semuaProduk=[];
let produkDipilih={};

fetch(`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${encodeURIComponent(sheetName)}`)
.then(res=>res.text())
.then(data=>{
 let json=JSON.parse(data.substring(47).slice(0,-2));
 semuaProduk=json.table.rows
 .filter(r=>r.c[0] && r.c[1])
 .map(r=>({
   kode:r.c[0]?.v||"",
   nama:r.c[1]?.v||"",
   harga:parseInt(r.c[3]?.v)||0
 }));
 renderProduk();
});

// ================= RENDER =================
function renderProduk(){
 let keyword=document.getElementById("cari").value.toLowerCase();
 let list=document.getElementById("listProduk");
 list.innerHTML="";

 semuaProduk
 .filter(p=>p.nama.toLowerCase().includes(keyword))
 .forEach(p=>{
   let div=document.createElement("div");
   div.className="card";

   let qty=produkDipilih[p.kode]?.qty || 0;

   div.innerHTML=
   "<b>"+p.nama+"</b><br>"+
   "<span class='harga'>Rp "+p.harga.toLocaleString()+"</span><br><br>";

   if(qty==0){
     let btn=document.createElement("button");
     btn.innerText="+ Tambah";
     btn.onclick=()=>{produkDipilih[p.kode]={...p,qty:1};renderProduk();}
     div.appendChild(btn);
   }else{
     let box=document.createElement("div");
     box.className="qtyBox";
     box.innerHTML=
     "<button class='qtyBtn' onclick=\"produkDipilih['"+p.kode+"'].qty--; if(produkDipilih['"+p.kode+"'].qty<=0){delete produkDipilih['"+p.kode+"'];} renderProduk();\">-</button>"+
     "<span>"+qty+"</span>"+
     "<button class='qtyBtn' onclick=\"produkDipilih['"+p.kode+"'].qty++; renderProduk();\">+</button>";
     div.appendChild(box);
   }

   list.appendChild(div);
 });

 updateRingkasan();
}

// ================= MAP =================
const tokoLat=-6.7995;
const tokoLng=108.3441;

let tujuanLat=null;
let tujuanLng=null;
let ongkirFix=0;
let minimalBelanja=0;
let jarakFix=0;

var map=L.map('map').setView([tokoLat,tokoLng],13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

L.marker([tokoLat,tokoLng]).addTo(map);

let marker;

map.on('click',function(e){
 tujuanLat=e.latlng.lat;
 tujuanLng=e.latlng.lng;
 if(marker) map.removeLayer(marker);
 marker=L.marker([tujuanLat,tujuanLng]).addTo(map);
 hitungZona();
});

function gunakanLokasi(){
 navigator.geolocation.getCurrentPosition(pos=>{
  tujuanLat=pos.coords.latitude;
  tujuanLng=pos.coords.longitude;
  if(marker) map.removeLayer(marker);
  marker=L.marker([tujuanLat,tujuanLng]).addTo(map);
  hitungZona();
 });
}

function hitungZona(){
 jarakFix = map.distance([tokoLat,tokoLng],[tujuanLat,tujuanLng])/1000;
 ongkirFix = Math.round(jarakFix*2000);
 if(ongkirFix<10000) ongkirFix=10000;

 minimalBelanja=0;
 if(jarakFix>10 && jarakFix<=20) minimalBelanja=200000;
 else if(jarakFix>20 && jarakFix<=30) minimalBelanja=300000;
 else if(jarakFix>30 && jarakFix<=40) minimalBelanja=500000;
 else if(jarakFix>40) minimalBelanja=700000;

 updateRingkasan();
}

// ================= RINGKASAN AUTO =================
function updateRingkasan(){
 let total=0;
 let totalItem=0;

 Object.values(produkDipilih).forEach(p=>{
  total+=p.harga*p.qty;
  totalItem+=p.qty;
 });

 let kurang= minimalBelanja>0 ? minimalBelanja-total : 0;

 let status="";
 let btn=document.getElementById("btnCheckout");

 if(minimalBelanja>0){
  if(total<minimalBelanja){
   status="<br><span style='color:red'>Tambah lagi Rp"+kurang.toLocaleString()+" agar bisa diantar</span>";
   btn.classList.add("disabled");
  }else{
   status="<br><span style='color:green'>‚úî Sudah memenuhi minimal belanja</span>";
   btn.classList.remove("disabled");
  }
 }else{
   btn.classList.remove("disabled");
 }

 document.getElementById("ringkasan").innerHTML=
 totalItem+" Pcs | Rp"+total.toLocaleString()+" | Ongkir Rp"+ongkirFix.toLocaleString()+status;

 document.getElementById("infoArea").innerHTML=
 "Jarak: "+jarakFix.toFixed(1)+" km | Minimal Belanja: Rp"+minimalBelanja.toLocaleString();
}

// ================= PROSES WA =================
function proses(){

 if(document.getElementById("btnCheckout").classList.contains("disabled")){
  alert("Belum memenuhi minimal belanja.");
  return;
 }

 let noWa=document.getElementById("waPembeli").value.trim();
 if(noWa=="" || !tujuanLat){
  alert("Lengkapi data dulu!");
  return;
 }

 let total=0;
 let totalItem=0;
 let detail="";
 let no=1;

 Object.values(produkDipilih).forEach(p=>{
  let sub=p.harga*p.qty;
  total+=sub;
  totalItem+=p.qty;
  detail+=no+". "+p.nama+" x"+p.qty+" - Rp "+sub.toLocaleString()+"%0A";
  no++;
 });

 let totalBayar=total+ongkirFix;

 let pesan=
 "üì¶ PESANAN BARU%0A%0A"+
 detail+
 "%0ATotal Item: "+totalItem+
 "%0ATotal Barang: Rp"+total.toLocaleString()+
 "%0AOngkir: Rp"+ongkirFix.toLocaleString()+
 "%0ATotal Bayar: Rp"+totalBayar.toLocaleString();

 window.open("https://wa.me/6282319264646?text="+pesan);
}

</script>
</body>
</html></div>

<script>

tampilProduk(dataProduk);
});

// ================= TAMPIL PRODUK =================
function tampilProduk(list){
 hasil.innerHTML="";
 list.forEach(p=>{

 let selected=produkDipilih[p.kode];
 let qty=selected?selected.qty:0;

 hasil.innerHTML+=`
 <div class="card">
  <b>${p.nama}</b><br>
  <small>${p.kode}</small><br>
  <span class="harga">Rp ${p.harga.toLocaleString()}</span><br><br>

  ${
   qty===0
   ? `<button onclick="tambahProduk('${p.kode}')">+ Tambah</button>`
   : `
   <div class="qty-box">
    <button class="qty-btn" onclick="kurangProduk('${p.kode}')">-</button>
    <b>${qty}</b>
    <button class="qty-btn" onclick="tambahProduk('${p.kode}')">+</button>
   </div>
   `
  }
 </div>`;
 });
}

function tambahProduk(kode){
 let produk=dataProduk.find(p=>p.kode===kode);
 if(!produkDipilih[kode]){
  produkDipilih[kode]={...produk,qty:1};
 }else{
  produkDipilih[kode].qty++;
 }
 tampilProduk(dataProduk);
 updateCart();
}

function kurangProduk(kode){
 if(produkDipilih[kode]){
  produkDipilih[kode].qty--;
  if(produkDipilih[kode].qty<=0){
   delete produkDipilih[kode];
  }
 }
 tampilProduk(dataProduk);
 updateCart();
}

function filterProduk(){
 let q=cari.value.toLowerCase();
 tampilProduk(dataProduk.filter(x=>
 x.nama.toLowerCase().includes(q)||
 x.kode.toLowerCase().includes(q)
 ));
}

// ================== RENDER ==================
function renderProduk(){
 let keyword=document.getElementById("cari").value.toLowerCase();
 let list=document.getElementById("listProduk");
 list.innerHTML="";

 semuaProduk
 .filter(p=>p.nama.toLowerCase().includes(keyword))
 .forEach(p=>{

  let div=document.createElement("div");
  div.className="card";

  let qty=produkDipilih[p.kode]?.qty || 0;

  div.innerHTML=
  "<b>"+p.nama+"</b><br>"+
  "<span class='harga'>Rp "+p.harga.toLocaleString()+"</span><br><br>";

  if(qty==0){
    let btn=document.createElement("button");
    btn.className="btnTambah";
    btn.innerText="+ Tambah";
    btn.onclick=()=>tambahProduk(p);
    div.appendChild(btn);
  }else{
    let box=document.createElement("div");
    box.className="qtyBox";
    box.innerHTML=
    "<button class='qtyBtn' onclick=\"kurang('"+p.kode+"')\">-</button>"+
    "<span>"+qty+"</span>"+
    "<button class='qtyBtn' onclick=\"tambah('"+p.kode+"')\">+</button>";
    div.appendChild(box);
  }

  list.appendChild(div);
 });

 updateRingkasan();
}

// ================== TAMBAH / KURANG ==================
function tambahProduk(p){
 produkDipilih[p.kode]={...p, qty:1};
 renderProduk();
}
function tambah(kode){
 produkDipilih[kode].qty++;
 renderProduk();
}
function kurang(kode){
 produkDipilih[kode].qty--;
 if(produkDipilih[kode].qty<=0){
  delete produkDipilih[kode];
 }
 renderProduk();
}

// ================== RINGKASAN ==================
function updateRingkasan(){
 let total=0;
 let totalItem=0;

 Object.values(produkDipilih).forEach(p=>{
  total+=p.harga*p.qty;
  totalItem+=p.qty;
 });

 document.getElementById("ringkasan").innerText=
 Object.keys(produkDipilih).length+" Produk | "+
 totalItem+" Pcs | Rp"+
 total.toLocaleString();
}

// ================== MAP ==================
const tokoLat=-6.7995;
const tokoLng=108.3441;

let tujuanLat=null;
let tujuanLng=null;
let ongkirFix=0;
let minimalBelanja=0;
let jarakFix=0;

var map=L.map('map').setView([tokoLat,tokoLng],13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

L.marker([tokoLat,tokoLng]).addTo(map)
.bindPopup("Lokasi Toko").openPopup();

let marker;

map.on('click',function(e){
 tujuanLat=e.latlng.lat;
 tujuanLng=e.latlng.lng;

 if(marker) map.removeLayer(marker);
 marker=L.marker([tujuanLat,tujuanLng]).addTo(map);

 hitungOngkir();
});

function gunakanLokasi(){
 navigator.geolocation.getCurrentPosition(pos=>{
  tujuanLat=pos.coords.latitude;
  tujuanLng=pos.coords.longitude;

  if(marker) map.removeLayer(marker);
  marker=L.marker([tujuanLat,tujuanLng]).addTo(map);

  hitungOngkir();
 });
}

function hitungOngkir(){
 jarakFix = map.distance(
  [tokoLat,tokoLng],
  [tujuanLat,tujuanLng]
 )/1000;

 ongkirFix=Math.round(jarakFix*2000);
 if(ongkirFix<10000) ongkirFix=10000;

 minimalBelanja=0;

 if(jarakFix>10 && jarakFix<=20) minimalBelanja=200000;
 else if(jarakFix>20 && jarakFix<=30) minimalBelanja=300000;
 else if(jarakFix>30 && jarakFix<=40) minimalBelanja=500000;
 else if(jarakFix>40) minimalBelanja=700000;

 let warna = "green";
 if(minimalBelanja>0) warna="red";

 document.getElementById("infoArea").innerHTML=
 "<span style='color:"+warna+"'>"+
 "Jarak: "+jarakFix.toFixed(1)+" km<br>"+
 "Ongkir: Rp"+ongkirFix.toLocaleString()+"<br>"+
 "Minimal Belanja: Rp"+minimalBelanja.toLocaleString()+
 "</span>";
}

// ================== PROSES WA ==================
function proses(){

 if(document.getElementById("btnCheckout").classList.contains("disabled")){
  alert("Belum memenuhi minimal belanja.");
  return;
 }

 let noWa=document.getElementById("waPembeli").value.trim();

 if(noWa=="" || !tujuanLat || !tujuanLng){
  alert("Lengkapi data & pilih lokasi dulu!");
  return;
 }

 let total=0;
 let totalItem=0;
 let detail="";
 let no=1;

 Object.values(produkDipilih).forEach(p=>{
  let sub=p.harga*p.qty;
  total+=sub;
  totalItem+=p.qty;

  detail+=
  no+". "+p.nama+
  " x"+p.qty+
  " - Rp "+sub.toLocaleString()+"\n";
  no++;
 });

 if(total < minimalBelanja){

  let kurang = minimalBelanja - total;

  alert(
    "‚ö† Jarak pengantaran: " + jarakFix.toFixed(1) + " km\n\n" +
    "Minimal belanja untuk area ini Rp" + minimalBelanja.toLocaleString() + "\n\n" +
    "Silakan tambah belanja lagi Rp" + kurang.toLocaleString() +
    " agar pesanan bisa kami antar üôè"
  );

  return;
 }

 let totalBayar=total+ongkirFix;

 let linkMaps="https://www.google.com/maps?q="+tujuanLat+","+tujuanLng;

 let pesan=
 "============================\n"+
 "üì¶ PESANAN BARU\n"+
 "============================\n\n"+
 detail+
 "\nTotal Item: "+totalItem+
 "\nTotal Barang: Rp"+total.toLocaleString()+
 "\nOngkir: Rp"+ongkirFix.toLocaleString()+
 "\nTotal Bayar: Rp"+totalBayar.toLocaleString()+
 "\n\nLokasi:\n"+linkMaps;

 let encoded = encodeURIComponent(pesan);

 window.open("https://wa.me/6282319264646?text="+encoded);
}
renderProduk();

</script>
<div class="scroll-buttons">
  <button onclick="scrollToTop()">‚¨Ü</button>
  <button onclick="scrollToBottom()">‚¨á</button>
</div>
<script>
function scrollToTop(){
  window.scrollTo({ top:0, behavior:'smooth' });
}

function scrollToBottom(){
  window.scrollTo({ top:document.body.scrollHeight, behavior:'smooth' });
}
</script>
</body>
</html>
