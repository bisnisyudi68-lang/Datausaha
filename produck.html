<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>TOKO SIAP ANTAR</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f2f2f2;padding-bottom:140px}
header{background:#15803d;color:white;padding:15px;text-align:center;font-size:20px;font-weight:bold}
input{width:95%;padding:10px;margin:10px;border-radius:8px;border:1px solid #ccc}
.card{background:white;margin:10px;padding:12px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,0.1)}
.harga{color:#15803d;font-weight:bold}
button{padding:6px 12px;border:none;border-radius:6px;cursor:pointer}
.btnTambah{background:#e5e5e5}
.qtyBox{display:flex;align-items:center;gap:10px;margin-top:8px}
.qtyBtn{background:#15803d;color:white;width:35px;height:35px}
#map{height:250px;margin:10px;border-radius:12px}

.infoZona{
 margin:10px;
 padding:10px;
 background:white;
 border-radius:10px;
 font-size:14px;
 box-shadow:0 2px 6px rgba(0,0,0,0.1);
}

.checkout{
 position:fixed;
 bottom:0;
 width:100%;
 background:#15803d;
 color:white;
 padding:15px;
 text-align:center;
 font-weight:bold;
 transition:0.3s;
}

.checkout.disabled{
 background:#9ca3af;
}

.scroll-buttons{
 position:fixed;
 right:15px;
 bottom:170px;
 display:flex;
 flex-direction:column;
 gap:10px;
 z-index:9999;
}

.scroll-buttons button{
 width:50px;
 height:50px;
 border-radius:50%;
 background:linear-gradient(145deg,#0d6efd,#2563eb);
 color:white;
 font-size:20px;
 box-shadow:0 4px 10px rgba(0,0,0,0.2);
}
</style>
</head>

<body>

<header>ğŸ›’ TOKO SIAP ANTAR</header>

<input type="text" id="cari" placeholder="Cari produk..." onkeyup="renderProduk()">

<div id="listProduk"></div>

<h3 style="margin-left:10px;">ğŸ“ Pilih Lokasi Rumah</h3>
<div id="map"></div>

<button onclick="gunakanLokasi()" style="width:95%;margin:10px;background:#2563eb;color:white;">
ğŸ“¡ Gunakan Lokasi Saya
</button>

<div id="infoZona" class="infoZona">
Belum memilih lokasi
</div>

<input type="text" id="waPembeli" placeholder="Nomor WhatsApp Anda (08xxxx)">

<div class="checkout disabled" id="btnCheckout" onclick="proses()">
<span id="ringkasan">0 Produk | 0 Pcs | Rp0</span><br>
Checkout & Kirim WhatsApp
</div>

<div class="scroll-buttons">
<button onclick="scrollToTop()">â†‘</button>
<button onclick="scrollToBottom()">â†“</button>
</div>


<script>

// ================= GOOGLE SHEET =================
const sheetUrl =
"https://docs.google.com/spreadsheets/d/1iPbtRGldW5yz6tuUZ5oHzMGsnNb4cHyCbAEMkq51qK4/gviz/tq?sheet=ZEVAN&tqx=out:json";

fetch(`https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${sheetName}&tqx=out:json`)
.then(res=>res.text())
.then(data=>{
  try{
    let json=JSON.parse(data.substring(47).slice(0,-2));

    semuaProduk=json.table.rows
    .filter(r=>r.c && r.c[0])
    .map(r=>({
      kode:r.c[0]?.v || "",
      nama:r.c[2]?.v || "",
      harga:Number(r.c[4]?.v || 0)
    }));

    console.log("ZEVAN:",semuaProduk);
    renderProduk();

  }catch(err){
    console.log("Gagal parsing:",err);
  }
})
.catch(err=>{
  console.log("Gagal fetch:",err);
});

// ================= PRODUK =================
function renderProduk(){
 let keyword=document.getElementById("cari").value.toLowerCase();
 let list=document.getElementById("listProduk");
 list.innerHTML="";

 semuaProduk
 .filter(p=>p.nama.toLowerCase().includes(keyword))
 .forEach(p=>{

   let div=document.createElement("div");
   div.className="card";
   let qty=produkDipilih[p.kode]?.qty||0;

   div.innerHTML=`
   <b>${p.nama}</b><br>
   ${p.kode}<br>
   <span class="harga">Rp ${Math.round(p.harga).toLocaleString()}</span>
   `;

   if(qty==0){
     let btn=document.createElement("button");
     btn.className="btnTambah";
     btn.innerText="+ Tambah";
     btn.onclick=()=>tambahProduk(p);
     div.appendChild(btn);
   }else{
     let box=document.createElement("div");
     box.className="qtyBox";
     box.innerHTML=`
       <button class="qtyBtn" onclick="kurang('${p.kode}')">-</button>
       <span>${qty}</span>
       <button class="qtyBtn" onclick="tambah('${p.kode}')">+</button>
     `;
     div.appendChild(box);
   }

   list.appendChild(div);
 });

 updateRingkasan();
}

function tambahProduk(p){
 produkDipilih[p.kode]={...p,qty:1};
 renderProduk();
}
function tambah(k){produkDipilih[k].qty++;renderProduk();}
function kurang(k){
 produkDipilih[k].qty--;
 if(produkDipilih[k].qty<=0)delete produkDipilih[k];
 renderProduk();
}


// ================= MAP =================
const tokoLat=-6.883831;
const tokoLng=108.302788;

let tujuanLat=null;
let tujuanLng=null;
let ongkirFix=0;
let jarakFix=0;
let minimalBelanja=0;
let marker;

var map=L.map('map').setView([tokoLat,tokoLng],15);

L.tileLayer(
'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
{ attribution:'&copy; OpenStreetMap contributors'}
).addTo(map);

L.marker([tokoLat,tokoLng])
.addTo(map)
.bindPopup("Lokasi Penjual")
.openPopup();

map.on('click',function(e){
 setLokasi(e.latlng.lat,e.latlng.lng);
});

function gunakanLokasi(){
 navigator.geolocation.getCurrentPosition(
  function(pos){
   setLokasi(pos.coords.latitude,pos.coords.longitude);
  },
  function(err){
   alert("Gagal ambil lokasi: "+err.message);
  },
  {
   enableHighAccuracy:true,
   timeout:15000,
   maximumAge:0
  }
 );
}

function setLokasi(lat,lng){
 tujuanLat=lat;
 tujuanLng=lng;

 if(marker) map.removeLayer(marker);

 marker=L.marker([lat,lng])
 .addTo(map)
 .bindPopup("Pesanan akan di kirim ke lokasi ini")
 .openPopup();

 map.setView([lat,lng],17);

 hitungZona();
}


// ================= HITUNG ZONA =================
function hitungZona(){

 jarakFix=map.distance(
  [tokoLat,tokoLng],
  [tujuanLat,tujuanLng]
 )/1000;

 ongkirFix=Math.round(jarakFix*2000);
 if(ongkirFix<10000) ongkirFix=10000;

 if(jarakFix<=10) minimalBelanja=0;
 else if(jarakFix<=20) minimalBelanja=200000;
 else if(jarakFix<=30) minimalBelanja=300000;
 else if(jarakFix<=40) minimalBelanja=500000;
 else minimalBelanja=700000;

 updateRingkasan();
}


// ================= RINGKASAN =================
function updateRingkasan(){

 let total=0,totalItem=0;

 Object.values(produkDipilih).forEach(p=>{
  total+=p.harga*p.qty;
  totalItem+=p.qty;
 });

 let btn=document.getElementById("btnCheckout");

 if(minimalBelanja>0 && total<minimalBelanja){
  btn.classList.add("disabled");
 }else{
  btn.classList.remove("disabled");
 }

 document.getElementById("ringkasan").innerText=
 Object.keys(produkDipilih).length+
 " Produk | "+
 totalItem+
 " Pcs | Rp"+
 total.toLocaleString();

 if(tujuanLat){
  let kurang=minimalBelanja-total;
  document.getElementById("infoZona").innerHTML=
  "Jarak: "+jarakFix.toFixed(1)+" km<br>"+
  "Ongkir: Rp"+ongkirFix.toLocaleString()+"<br>"+
  "Minimal Belanja: Rp"+minimalBelanja.toLocaleString()+
  (minimalBelanja>0 && total<minimalBelanja
   ? "<br><span style='color:red'>Tambah Rp"+kurang.toLocaleString()+" lagi agar bisa diantar</span>"
   : "<br><span style='color:green'>âœ” Siap dikirim</span>");
 }
}


// ================= PROSES WA =================
function proses(){

 if(document.getElementById("btnCheckout").classList.contains("disabled")){
  alert("Belum memenuhi minimal belanja.");
  return;
 }

 let noWa=document.getElementById("waPembeli").value.trim();

 if(noWa=="" || !tujuanLat || Object.keys(produkDipilih).length==0){
  alert("Lengkapi data dulu!");
  return;
 }

 let total=0,totalItem=0,detail="";

 Object.values(produkDipilih).forEach(p=>{
  let sub=p.harga*p.qty;
  total+=sub;
  totalItem+=p.qty;

  detail+=
  "â€¢ "+p.nama+"\n"+
  "  Qty: "+p.qty+"\n"+
  "  Harga: Rp"+sub.toLocaleString()+"\n\n";
 });

 let totalBayar=total+ongkirFix;

 let linkMaps=
 `https://www.google.com/maps/search/?api=1&query=${tujuanLat},${tujuanLng}`;

 let tanggal=new Date().toLocaleDateString("id-ID");
 let orderId=Date.now();

 let pesan=
"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"+
"ğŸ§¾ INVOICE PESANAN MASUK\n"+
"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"+
"ğŸ“Œ ID Order: #"+orderId+"\n"+
"ğŸ“… Tanggal: "+tanggal+"\n\n"+
"ğŸ‘¤ Nomor Pembeli:\n"+noWa+"\n\n"+
"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"+
"ğŸ“¦ Detail Produk\n"+
"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"+
detail+
"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"+
"ğŸ’° RINCIAN PEMBAYARAN\n"+
"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n"+
"Total Item   : "+totalItem+"\n"+
"Total Barang : Rp"+total.toLocaleString()+"\n"+
"Ongkir       : Rp"+ongkirFix.toLocaleString()+"\n"+
"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"+
"TOTAL BAYAR  : Rp"+totalBayar.toLocaleString()+"\n\n"+
"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"+
"ğŸ“ Titik Lokasi Pembeli\n"+
"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"+
linkMaps+"\n\n"+
"âš ï¸ Mohon cek kembali detail pesanan sebelum diproses.\n"+
"â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";

 window.open(
   "https://wa.me/6282319264646?text="+encodeURIComponent(pesan),
   "_blank"
 );
}


// ================= SCROLL =================
function scrollToTop(){
 window.scrollTo({top:0,behavior:'smooth'});
}
function scrollToBottom(){
 window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
}

</script>
